# Definitions
substitutions:
  _REMOTE: https://github.com/andrejusk/andrejusk.github.io

# Deployment
steps:

# Cloud Build x GitHub integration uses source archives to fetch
# the source, rather than Git source fetching, and as a consequence
# does not include the .git/ directory. As a workaround, we clone
# the repository to grab the .git directory.
#
# Source: https://github.com/google/clusterfuzz/pull/141
- name: gcr.io/cloud-builders/git
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    git clone ${_REMOTE} tmp
    git -C tmp fetch origin "$COMMIT_SHA"
    git -C tmp checkout -qf FETCH_HEAD
    mv tmp/.git .git
    mv tmp/.gitmodules .gitmodules
    rm -rf tmp
    git submodule update --init --recursive

# Build Hugo
- name: 'gcr.io/$PROJECT_ID/hugo'

# Deploy to GAE
- name: "gcr.io/cloud-builders/gcloud"
  args: ["app", "deploy"]